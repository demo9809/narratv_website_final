"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5250],{82734:function(e,t,r){r.d(t,{Qc:function(){return eH},ku:function(){return G}});var n=r(31464);class a{pattern;patternRe;constructor(e){this.pattern=e,this.patternRe=function(e){let t=[];for(let r of e.split("."))"*"===r?t.push("[^.]+"):"**"===r?t.push(".*"):t.push(r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"));return RegExp(`^${t.join(".")}$`)}(e)}matches(e){return this.patternRe.test(e)}toJSON(){return this.pattern}}let s=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?(Z|([-+]\d{2}:\d{2}))$/;function i(e,t){let r=e.toString();for(;r.length<t;)r=`0${r}`;return r}class o{data;type;constructor(e,t){this.data=e,this.type=t}isArray(){return"array"===this.type}async get(){return this.data}asStatic(){return this}[Symbol.asyncIterator](){if(Array.isArray(this.data))return function*(e){for(let t of e)yield m(t)}(this.data);throw Error(`Cannot iterate over: ${this.type}`)}}let c=new o(null,"null"),l=new o(!0,"boolean"),p=new o(!1,"boolean");class u{date;constructor(e){this.date=e}static parseToValue(e){let t=s.test(e)?new Date(e):null;return t?new o(new u(t),"datetime"):c}equals(e){return this.date.getTime()==e.date.getTime()}add(e){let t=new Date(this.date.getTime());return t.setTime(t.getTime()+1e3*e),new u(t)}difference(e){return(this.date.getTime()-e.date.getTime())/1e3}compareTo(e){return this.date.getTime()-e.date.getTime()}toString(){return function(e){let t=i(e.getUTCFullYear(),4),r=i(e.getUTCMonth()+1,2),n=i(e.getUTCDate(),2),a=i(e.getUTCHours(),2),s=i(e.getUTCMinutes(),2),o=i(e.getUTCSeconds(),2),c="",l=e.getMilliseconds();return 0!=l&&(c=`.${i(l,3)}`),`${t}-${r}-${n}T${a}:${s}:${o}${c}Z`}(this.date)}toJSON(){return this.toString()}}function f(e){return Number.isFinite(e)?new o(e,"number"):c}function y(e){return new o(e,"string")}function d(e){return new o(e,"datetime")}function h(e){return new o(e,"array")}function m(e){return e&&"function"==typeof e.next?new g(async function*(){for await(let t of e)yield m(t)}):null==e?c:new o(e,b(e))}function b(e){return null===e||typeof e>"u"?"null":Array.isArray(e)?"array":e instanceof a?"path":e instanceof u?"datetime":typeof e}class g{type="stream";generator;ticker;isDone;data;constructor(e){this.generator=e,this.ticker=null,this.isDone=!1,this.data=[]}isArray(){return!0}async get(){let e=[];for await(let t of this)e.push(await t.get());return e}async asStatic(){return new o(await this.get(),"array")}async *[Symbol.asyncIterator](){let e=0;for(;;){for(;e<this.data.length;e++)yield this.data[e];if(this.isDone)return;await this._nextTick()}}_nextTick(){let e,t;if(this.ticker)return this.ticker;let r=()=>{this.ticker=new Promise((r,n)=>{e=r,t=n})},n=()=>{e(),r()},a=async()=>{try{for await(let e of this.generator())this.data.push(e),n();this.isDone=!0,n()}catch(e){t(e)}};return r(),a(),this.ticker}}function w(e,t){return"string"===e.type&&"string"===t.type||"boolean"===e.type&&"boolean"===t.type||"null"===e.type&&"null"===t.type||"number"===e.type&&"number"===t.type?e.data===t.data:"datetime"===e.type&&"datetime"===t.type&&e.data.equals(t.data)}function x(e,t){if(null===e||null===t)return e===t;let r=typeof e,n=typeof t;if("undefined"===r&&"undefined"===n)return!0;if("function"===r&&"function"===n)return e===t;if("object"===r&&"object"===n){let r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return!1;for(let n of r)if(!x(e[n],t[n]))return!1;return!0}return e===t}let k=/([^!@#$%^&*(),\\/?";:{}|[\]+<>\s-])+/g,_=/([^!@#$%^&(),\\/?";:{}|[\]+<>\s-])+/g,E=/(\b\.+|\.+\b)/g;function v(e){return e.replace(E,"").match(k)||[]}function A(e){return(e.replace(E,"").match(_)||[]).map(e=>RegExp(`^${e.slice(0,1024).replace(/\*/g,".*")}$`,"i"))}function S(e,t){if("string"===e.type)return{parts:t(e.data),success:!0};if("array"===e.type){let r=!0,n=[];for(let a of e.data)"string"==typeof a?n.push(...t(a)):r=!1;return{parts:n,success:r}}return"stream"===e.type?(async()=>{let r=!0,n=[];for await(let a of e)"string"===a.type?n.push(...t(a.data)):r=!1;return{parts:n,success:r}})():{parts:[],success:!1}}let j={datetime:1,number:2,string:3,boolean:4};function O(e,t){let r=b(e);if(r!==b(t))return null;switch(r){case"number":case"boolean":return e-t;case"string":return e<t?-1:e>t?1:0;case"datetime":return e.compareTo(t);default:return null}}let C={"==":function(e,t){return w(e,t)?l:p},"!=":function(e,t){return w(e,t)?p:l},">":function(e,t){if("stream"===e.type||"stream"===t.type)return c;let r=O(e.data,t.data);return null===r?c:r>0?l:p},">=":function(e,t){if("stream"===e.type||"stream"===t.type)return c;let r=O(e.data,t.data);return null===r?c:r>=0?l:p},"<":function(e,t){if("stream"===e.type||"stream"===t.type)return c;let r=O(e.data,t.data);return null===r?c:r<0?l:p},"<=":function(e,t){if("stream"===e.type||"stream"===t.type)return c;let r=O(e.data,t.data);return null===r?c:r<=0?l:p},in:function(e,t){if("path"===t.type)return"string"!==e.type?c:t.data.matches(e.data)?l:p;if("array"===t.type){for(let r of t.data)if(w(e,m(r)))return l;return p}return"stream"===t.type?(async()=>{for await(let r of t)if(w(e,r))return l;return p})():c},match:function(e,t){let r=S(e,e=>v(e)),n=S(t,e=>A(e).map(e=>t=>t.some(t=>e.test(t)))),a=(e,t)=>{var r,n;return t.success&&(r=e.parts,n=t.parts,0!==r.length&&0!==n.length&&n.every(e=>e(r)))?l:p};return"then"in r||"then"in n?(async()=>a(await r,await n))():a(r,n)},"+":function(e,t){return"datetime"===e.type&&"number"===t.type?d(e.data.add(t.data)):"number"===e.type&&"number"===t.type?f(e.data+t.data):"string"===e.type&&"string"===t.type?y(e.data+t.data):"object"===e.type&&"object"===t.type?m({...e.data,...t.data}):"array"===e.type&&"array"===t.type?m(e.data.concat(t.data)):e.isArray()&&t.isArray()?new g(async function*(){for await(let t of e)yield t;for await(let e of t)yield e}):c},"-":function(e,t){return"datetime"===e.type&&"number"===t.type?d(e.data.add(-t.data)):"datetime"===e.type&&"datetime"===t.type?f(e.data.difference(t.data)):"number"===e.type&&"number"===t.type?f(e.data-t.data):c},"*":$((e,t)=>e*t),"/":$((e,t)=>e/t),"%":$((e,t)=>e%t),"**":$((e,t)=>Math.pow(e,t))};function $(e){return function(t,r){return"number"===t.type&&"number"===r.type?f(e(t.data,r.data)):c}}let I=class e{params;source;value;parent;context;isHidden=!1;constructor(e,t,r,n,a){this.params=e,this.source=t,this.value=r,this.context=n,this.parent=a}createNested(t){return this.isHidden?new e(this.params,this.source,t,this.context,this.parent):new e(this.params,this.source,t,this.context,this)}createHidden(e){let t=this.createNested(e);return t.isHidden=!0,t}};function T(e,t){return q[e.type].executeSync(e,t)}function M(e,t){return q[e.type].executeAsync(e,t)}function F(e){return{executeSync(){throw Error("executeSync not supported")},executeAsync:e}}function P(e){return{executeSync(t,r){let n=e(t,r);if("stream"===n.type)throw Error("Stream encountered in evaluateSync");return n},executeAsync:async(t,r)=>e(t,r)}}function N(e,t){return{executeSync(r,n){let a=e(r).map(e=>T(e,n)),s=t(r,...a);if("stream"===s.type)throw Error("Stream/iterator not supported in synchronous mode");return s},async executeAsync(r,n){let a=e(r);return t(r,...await Promise.all(a.map(e=>M(e,n).then(e=>e.asStatic()))))}}}let U=Symbol();function D(e,t,r,n){return{executeSync(a,s){let{array:i,args:o=[]}=e(a),l=T(i,s);if("array"!==l.type)return c;let p=o.map(e=>T(e,s)),u=t(a,...p);for(let e of l.data){let t=r(a,u,e,...p);if(t===U)return c;u=t}return n(u)},async executeAsync(a,s){let{array:i,args:o=[]}=e(a),l=await M(i,s);if("array"!==l.type&&"stream"!==l.type)return c;let p=await Promise.all(o.map(e=>M(e,s).then(e=>e.asStatic()))),u=t(a,...p);if("stream"===l.type)for await(let e of l){let t=r(a,u,await e.get(),...p);if(t===U)return c;u=t}else for(let e of l.data){let t=r(a,u,e,...p);if(t===U)return c;u=t}return n(u)}}}function V(e,t,{hidden:r=!1}={}){return{executeSync(n,a){let s=e(n),i=T(s.array,a);if("array"!==i.type)return c;let o=[];for(let e of i.data){let i;if(s.inner){let t=r?a.createHidden(m(e)):a.createNested(m(e));i=T(s.inner,t).data}for(let r of t(n,e,i,s.state))o.push(r)}return h(o)},async executeAsync(n,a){let s=e(n),i=await M(s.array,a);return i.isArray()?new g(async function*(){for await(let e of i){let i;if(s.inner){let t=r?a.createHidden(e):a.createNested(e);i=await (await M(s.inner,t)).get()}for(let r of t(n,await e.get(),i,s.state))yield m(r)}}):c}}}let q={This:P((e,t)=>t.value),SelectorNested:P(()=>{throw Error("Unexpected node type: SelectorNested")}),SelectorFuncCall:P(()=>{throw Error("Unexpected node type: SelectorFuncCall")}),Everything:P((e,t)=>t.source),Parameter:P(({name:e},t)=>m(t.params[e])),Context:P(({key:e},t)=>{if("before"===e||"after"===e)return t.context[e]||c;throw Error(`unknown context key: ${e}`)}),Parent:P(({n:e},t)=>{let r=t;for(let t=0;t<e;t++){if(!r.parent)return c;r=r.parent}return r.value}),OpCall:{async executeAsync({op:e,left:t,right:r},n){let a=C[e];if(!a)throw Error(`Unknown operator: ${e}`);return a(await M(t,n),await M(r,n))},executeSync({op:e,left:t,right:r},n){let a=C[e];if(!a)throw Error(`Unknown operator: ${e}`);let s=a(T(t,n),T(r,n));if("then"in s||"stream"===s.type)throw Error(`Operator ${e} not possible in evaluteSync`);return s}},Select:{executeSync({alternatives:e,fallback:t},r){for(let t of e){let e=T(t.condition,r);if("boolean"===e.type&&!0===e.data)return T(t.value,r)}return t?T(t,r):c},async executeAsync({alternatives:e,fallback:t},r){for(let t of e){let e=await M(t.condition,r);if("boolean"===e.type&&!0===e.data)return M(t.value,r)}return t?M(t,r):c}},InRange:N(({base:e,left:t,right:r})=>[e,t,r],({isInclusive:e},t,r,n)=>{let a=O(t.data,r.data);if(null===a)return c;let s=O(t.data,n.data);return null===s?c:e?a>=0&&s<=0?l:p:a>=0&&s<0?l:p}),Filter:V(({base:e,expr:t})=>({array:e,inner:t}),function*(e,t,r){!0===r&&(yield t)}),Projection:{executeSync({base:e,expr:t},r){let n=T(e,r);return"object"!==n.type?c:T(t,r.createNested(n))},async executeAsync({base:e,expr:t},r){let n=await M(e,r);return"object"!==n.type?c:M(t,r.createNested(n))}},FuncCall:{executeAsync:({func:e,args:t},r)=>e.executeAsync(t,r),executeSync:({func:e,args:t},r)=>e.executeSync(t,r)},PipeFuncCall:{async executeAsync({func:e,base:t,args:r},n){let a=await M(t,n);return"stream"!==a.type&&"array"!==a.type?c:e.executeAsync({base:a,args:r},n)},executeSync({func:e,base:t,args:r},n){let a=T(t,n);return"array"!==a.type?c:e.executeSync({base:a,args:r},n)}},AccessAttribute:N(({base:e})=>[e||{type:"This"}],({name:e},t)=>"object"===t.type&&t.data.hasOwnProperty(e)?m(t.data[e]):c),AccessElement:N(({base:e})=>[e],({index:e},t)=>{if("array"!==t.type)return c;let r=t.data,n=e<0?e+r.length:e;return m(r[n])}),Slice:N(({base:e})=>[e],({left:e,right:t,isInclusive:r},n)=>{if("array"!==n.type)return c;let a=n.data,s=e,i=t;return s<0&&(s=a.length+s),i<0&&(i=a.length+i),r&&i++,s<0&&(s=0),i<0&&(i=0),h(a.slice(s,i))}),Deref:{executeSync({base:e},t){let r=T(e,t);if("object"!==r.type)return c;let n=r.data._ref;if("string"!=typeof n)return c;if(t.context.dereference){let e=t.context.dereference({_ref:n});if(e&&"object"==typeof e&&"then"in e)throw Error("Dereference returned promise in synchronous mode");return m(e)}if("array"!==t.source.type)return c;for(let e of t.source.data)if(e&&"object"==typeof e&&"_id"in e&&n===e._id)return m(e);return c},async executeAsync({base:e},t){let r=await M(e,t);if(!t.source.isArray()||"object"!==r.type)return c;let n=r.data._ref;if("string"!=typeof n)return c;if(t.context.dereference)return m(await t.context.dereference({_ref:n}));for await(let e of t.source)if("object"===e.type&&n===e.data._id)return e;return c}},Value:P(({value:e})=>m(e)),Group:{executeSync:({base:e},t)=>T(e,t),executeAsync:({base:e},t)=>M(e,t)},Object:{executeSync({attributes:e},t){let r={};for(let n of e){let e=n.type;switch(n.type){case"ObjectAttributeValue":{let e=T(n.value,t);r[n.name]=e.data;break}case"ObjectConditionalSplat":{let e=T(n.condition,t);if("boolean"!==e.type||!1===e.data)continue;let a=T(n.value,t);"object"===a.type&&Object.assign(r,a.data);break}case"ObjectSplat":{let e=T(n.value,t);"object"===e.type&&Object.assign(r,e.data);break}default:throw Error(`Unknown node type: ${e}`)}}return m(r)},async executeAsync({attributes:e},t){let r={};for(let n of e){let e=n.type;switch(n.type){case"ObjectAttributeValue":{let e=await M(n.value,t);r[n.name]=await e.get();break}case"ObjectConditionalSplat":{let e=await M(n.condition,t);if("boolean"!==e.type||!1===e.data)continue;let a=await M(n.value,t);"object"===a.type&&Object.assign(r,a.data);break}case"ObjectSplat":{let e=await M(n.value,t);"object"===e.type&&Object.assign(r,e.data);break}default:throw Error(`Unknown node type: ${e}`)}}return m(r)}},Array:{executeSync({elements:e},t){let r=[];for(let n of e){let e=T(n.value,t);if(n.isSplat){if("array"===e.type)for(let t of e.data)r.push(t)}else r.push(e.data)}return h(r)},executeAsync:async({elements:e},t)=>new g(async function*(){for(let r of e){let e=await M(r.value,t);if(r.isSplat){if(e.isArray())for await(let t of e)yield t}else yield e}})},Tuple:P(()=>{throw Error("tuples can not be evaluated")}),Or:N(({left:e,right:t})=>[e,t],(e,t,r)=>"boolean"===t.type&&!0===t.data||"boolean"===r.type&&!0===r.data?l:"boolean"!==t.type||"boolean"!==r.type?c:p),And:N(({left:e,right:t})=>[e,t],(e,t,r)=>"boolean"===t.type&&!1===t.data||"boolean"===r.type&&!1===r.data?p:"boolean"!==t.type||"boolean"!==r.type?c:l),Not:N(({base:e})=>[e],(e,t)=>"boolean"!==t.type?c:t.data?p:l),Neg:N(({base:e})=>[e],(e,t)=>"number"!==t.type?c:f(-t.data)),Pos:N(({base:e})=>[e],(e,t)=>"number"!==t.type?c:f(t.data)),Asc:P(()=>c),Desc:P(()=>c),ArrayCoerce:{executeSync({base:e},t){let r=T(e,t);return r.isArray()?r:c},async executeAsync({base:e},t){let r=await M(e,t);return r.isArray()?r:c}},Map:V(({base:e,expr:t})=>({array:e,inner:t}),function*(e,t,r){yield r},{hidden:!0}),FlatMap:V(({base:e,expr:t})=>({array:e,inner:t}),function*(e,t,r){if(Array.isArray(r))for(let e of r)yield e;else yield r},{hidden:!0})};function G(e,t={}){return M(e,function(e){let t=m(e.root),r=m(e.dataset);return new I({...e.params},r,t,{timestamp:e.timestamp||new Date,identity:void 0===e.identity?"me":e.identity,sanity:e.sanity,after:e.after?m(e.after):null,before:e.before?m(e.before):null,dereference:e.dereference},null)}(t))}let H=new I({},c,c,{timestamp:new Date(0),identity:"me",before:null,after:null},null);function R(e){return!function e(t){switch(t.type){case"Group":case"Pos":case"Neg":return e(t.base);case"Value":case"Parameter":return!0;case"OpCall":switch(t.op){case"+":case"-":case"*":case"/":case"%":case"**":return e(t.left)&&e(t.right);default:return!1}default:return!1}}(e)?null:T(e,H)}function B(e){return["AccessAttribute","SelectorFuncCall","Group","Tuple","ArrayCoerce","Filter","SelectorNested"].includes(e.type)}let Z={};Z.join=N(e=>e,(e,t,r)=>{if("array"!==t.type||"string"!==r.type)return c;let n="",a=!1;for(let e of t.data){switch(a&&(n+=r.data),b(e)){case"number":case"string":case"boolean":case"datetime":n+=`${e}`;break;default:return c}a=!0}return y(n)}),Z.join.arity=2,Z.compact=V(([e])=>({array:e}),function*(e,t){null!==t&&(yield t)}),Z.compact.arity=1,Z.unique=V(e=>({array:e[0],state:new Set}),function*(e,t,r,n){switch(b(t)){case"number":case"string":case"boolean":case"datetime":n.has(t)||(n.add(t),yield t);break;default:yield t}}),Z.unique.arity=1,Z.intersects=N(e=>e,(e,t,r)=>{if("array"!==t.type||"array"!==r.type)return c;for(let e of t.data)for(let t of r.data)if(w(m(e),m(t)))return l;return p}),Z.intersects.arity=2;let z={};async function Q(e,t){let r=await e.get();for(let e of t)if(!(r=function(e,t){try{return e[t]}catch{return}}(r,e)))break;return r}async function*W(e,t){let r=[[]];for(;r.length>0;){let n=r.shift()||[],a=m(await Q(e,n)),s=m(await Q(t,n));if(s.type!==a.type)yield n;else if("string"===s.type&&"string"===a.type||"boolean"===s.type&&"boolean"===a.type||"null"===s.type&&"null"===a.type||"number"===s.type&&"number"===a.type)s.data!==a.data&&(yield n);else if("datetime"===s.type&&"datetime"===a.type)s.data.equals(a.data)||(yield n);else if("object"===s.type&&"object"===a.type){if(!x(s.data,a.data)){let e=Object.keys(s.data),t=Object.keys(a.data);new Set(e.concat(t)).forEach(e=>{r.push([...n,e])})}}else if("array"===s.type&&"array"===a.type){if(s.data.length!==a.data.length)yield n;else if(!x(s.data,a.data))for(let e=0;e<a.data.length;e++)r.push([...n,e])}else if("stream"===s.type&&"stream"===a.type){let e=await s.get(),t=await a.get();if(e.length!==t.length)yield n;else if(!x(e,t))for(let e=0;e<t.length;e++)r.push([...n,e])}}}async function J(e,t,r){switch(e.type){case"Group":return await J(e.base,t,r);case"Tuple":let n=[];for(let a of e.members){let e=await J(a,t,r);n.push(...e)}return n;case"AccessAttribute":return e.base?(await J(e.base,t,r)).map(t=>[...t,e.name]):[[e.name]];case"ArrayCoerce":{let n=await J(e.base,t,r),a=[];for(let e of n){let r=await Q(t,e);if(Array.isArray(r))for(let t=0;t<r.length;t++)a.push([...e,t])}return a}case"Filter":{let n=await J(e.base,t,r),a={...e,base:{type:"This"}},s=[];for(let e of n){let n=await Q(t,e);if(Array.isArray(n))for(let t=0;t<n.length;t++){let i=n[t],o=r.createNested(m([i]));(await (await M(a,o)).get()).length>0&&s.push([...e,t])}}return s}case"SelectorFuncCall":return L(e.arg,r.createHidden(t));case"SelectorNested":{let{base:n,nested:a}=e,s=await J(n,t,r),i=[];for(let e of s){let n=await Q(t,e);switch(a.type){case"AccessAttribute":case"ArrayCoerce":case"Filter":let s=await J(a,m(n),r);for(let t=0;t<s.length;t++)i.push([...e,...s[t]]);break;case"Group":for(let t of(await J(a.base,m(n),r)))i.push([...e,...t]);break;case"Tuple":for(let t of a.members)for(let a of(await J(t,m(n),r)))i.push([...e,...a])}}return i}}}async function L(e,t,r=[]){let n=t.value,a=[];if(n.isArray()){let s=await n.get();for(let n=0;n<s.length;n++){let i=await L(e,t.createHidden(m(s[n])),[...r,n]);a.push(...i)}}else if("object"===n.type){let s=await M(e,t);for(let i of("boolean"===s.type&&!0===s.data&&a.push(r),Object.keys(n.data))){let s=await L(e,t.createHidden(m(n.data[i])),[...r,i]);a.push(...s)}}return a}async function Y(e,t,r,n){let a=n.createHidden(e),s=await J(r,a.value,a),i=n.createHidden(t),o=await J(r,i.value,i);if(s.length!==o.length)return l;for(let r of s){for(let n=0;n<r.length;n++)if("number"==typeof r[n]){let a=r.slice(0,n),s=await Q(e,a),i=await Q(t,a);if(!Array.isArray(s)||!Array.isArray(i)||s.length!==i.length)return l}if(!x(await Q(e,r),await Q(t,r)))return l}return p}async function K(e,t,r,n){let a=n.createHidden(e),s=await J(r,a.value,a);for await(let r of W(e,t)){let e=!1;for(let t of s)if(function(e,t){return t.every((t,r)=>e[r]===t)}(r,t)){e=!0;break}if(!e)return p}return l}z.now=P((e,t)=>d(new u(t.context.timestamp))),z.now.arity=0;let X={};X.changedAny=F(async(e,t)=>{let r=e[0],n=e[1],a=e[2];if(!B(a))throw Error("changedAny third argument must be a selector");return Y(await M(r,t),await M(n,t),a,t)}),X.changedAny.arity=3,X.changedOnly=F(async(e,t)=>{let r=e[0],n=e[1],a=e[2];if(!B(a))throw Error("changedOnly third argument must be a selector");return K(await M(r,t),await M(n,t),a,t)}),X.changedOnly.arity=3;let ee={};ee.operation=P((e,t)=>{let r=null!==t.context.before,n=null!==t.context.after;return r&&n?y("update"):n?y("create"):r?y("delete"):c}),ee.changedAny=F(async(e,t)=>{let r=t.context.before||c,n=t.context.after||c,a=e[0];if(!B(a))throw Error("changedAny first argument must be a selector");return Y(r,n,a,t)}),ee.changedAny.arity=1,ee.changedAny.mode="delta",ee.changedOnly=F(async(e,t)=>{let r=t.context.before||c,n=t.context.after||c,a=e[0];if(!B(a))throw Error("changedOnly first argument must be a selector");return K(r,n,a,t)}),ee.changedOnly.arity=1,ee.changedOnly.mode="delta";let et={};et.get=P(()=>{throw Error("not implemented")}),et.incomingRefCount=P(()=>{throw Error("not implemented")}),et.incomingGlobalDocumentReferenceCount=P(()=>{throw Error("not implemented")});let er={};er.latLng=P(()=>{throw Error("not implemented")}),er.contains=P(()=>{throw Error("not implemented")}),er.intersects=P(()=>{throw Error("not implemented")}),er.distance=P(()=>{throw Error("not implemented")});let en={};en.lower=N(e=>e,(e,t)=>"string"!==t.type?c:y(t.data.toLowerCase())),en.lower.arity=1,en.upper=N(e=>e,(e,t)=>"string"!==t.type?c:y(t.data.toUpperCase())),en.upper.arity=1,en.split=N(e=>e,(e,t,r)=>"string"!==t.type||"string"!==r.type?c:0===t.data.length?h([]):0===r.data.length?h(Array.from(t.data)):h(t.data.split(r.data))),en.split.arity=2,en.startsWith=N(e=>e,(e,t,r)=>"string"!==t.type||"string"!==r.type?c:t.data.startsWith(r.data)?l:p),en.startsWith.arity=2;let ea={};ea.anywhere=P(()=>{throw Error("not implemented")}),ea.anywhere.arity=1,ea.coalesce={async executeAsync(e,t){for(let r of e){let e=await M(r,t);if("null"!==e.type)return e}return c},executeSync(e,t){for(let r of e){let e=T(r,t);if("null"!==e.type)return e}return c}},ea.count=D(e=>({array:e[0]}),()=>0,(e,t)=>t+1,f),ea.count.arity=1,ea.dateTime=N(e=>e,(e,t)=>"datetime"===t.type?t:"string"!==t.type?c:u.parseToValue(t.data)),ea.dateTime.arity=1,ea.defined=N(e=>e,(e,t)=>"null"===t.type?p:l),ea.defined.arity=1,ea.identity=P((e,t)=>y(t.context.identity)),ea.identity.arity=0,ea.length=N(e=>e,(e,t)=>"string"===t.type?f(function(e){let t=0;for(let r=0;r<e.length;r++){let n=e.charCodeAt(r);n>=55296&&n<=56319||t++}return t}(t.data)):"array"===t.type?f(t.data.length):c),ea.length.arity=1,ea.path=N(e=>e,(e,t)=>"string"!==t.type?c:new o(new a(t.data),"path")),ea.path.arity=1,ea.string=N(e=>e,(e,t)=>{switch(t.type){case"number":case"string":case"boolean":case"datetime":return y(`${t.data}`);default:return c}}),ea.string.arity=1,ea.references=N(e=>[{type:"This"},...e],(e,t,...r)=>{let n=new Set;for(let e of r)if("string"===e.type)n.add(e.data);else if("array"===e.type)for(let t of e.data)"string"==typeof t&&n.add(t);return 0===n.size?p:!function e(t,r){switch(b(t)){case"array":for(let n of t)if(e(n,r))return!0;break;case"object":if(t._ref)return r.has(t._ref);for(let n of Object.values(t))if(e(n,r))return!0}return!1}(t,n)?p:l}),ea.references.arity=e=>e>=1,ea.round=N(e=>e,(e,t,r)=>{if("number"!==t.type)return c;let n=t.data,a=0;if(r){if("number"!==r.type||r.data<0||!Number.isInteger(r.data))return c;a=r.data}return 0===a?n<0?f(-Math.round(-n)):f(Math.round(n)):f(Number(n.toFixed(a)))}),ea.round.arity=e=>e>=1&&e<=2,ea.now=P((e,t)=>y(t.context.timestamp.toISOString())),ea.now.arity=0,ea.boost=P(()=>{throw Error("unexpected boost call")}),ea.boost.arity=2,ea.lower=en.lower,ea.upper=en.upper;let es={};es.min=D(e=>({array:e[0]}),()=>{},(e,t,r)=>null===r?t:"number"!=typeof r?U:void 0===t||r<t?r:t,e=>void 0===e?c:f(e)),es.min.arity=1,es.max=D(e=>({array:e[0]}),()=>{},(e,t,r)=>null===r?t:"number"!=typeof r?U:void 0===t||r>t?r:t,e=>void 0===e?c:f(e)),es.max.arity=1,es.sum=D(e=>({array:e[0]}),()=>0,(e,t,r)=>null===r?t:"number"!=typeof r?U:t+r,f),es.sum.arity=1,es.avg=D(e=>({array:e[0]}),()=>({count:0,sum:0}),(e,{count:t,sum:r},n)=>null===n?{count:t,sum:r}:"number"!=typeof n?U:{count:t+1,sum:r+n},({count:e,sum:t})=>0===e?c:f(t/e)),es.avg.arity=1;let ei={};function eo(e){if("string"!=typeof e._type)return null;let t=e.children;if(!Array.isArray(t))return null;let r="";for(let e of t)e&&"object"==typeof e&&"string"==typeof e._type&&"span"===e._type&&"string"==typeof e.text&&(r+=e.text);return r}ei.aspect=P(()=>{throw Error("not implemented")}),ei.aspect.arity=2;let ec={};ec.text=N(e=>e,function(e,t){let r=function(e){if("object"===e.type)return eo(e.data);if("array"===e.type){let t=function e(t,r=[]){for(let n of t)if(Array.isArray(n))e(n,r);else if("object"==typeof n&&n){let e=eo(n);null!==e&&r.push(e)}return r}(e.data);if(t.length>0)return t.join(`

`)}return null}(t);return null===r?c:y(r)}),ec.text.arity=1;let el={};el.all=V(()=>({array:{type:"Everything"}}),function*(e,t){"object"==typeof t&&t&&"_type"in t&&"system.release"===t._type&&(yield t)}),el.all.arity=0;let ep={};ep.projectId=P((e,t)=>t.context.sanity?y(t.context.sanity.projectId):c),ep.dataset=P((e,t)=>t.context.sanity?y(t.context.sanity.dataset):c),ep.versionOf=N(([e])=>[e,{type:"This"}],(e,t,r)=>{if("string"!==t.type)return c;let n=t.data;if("object"!==r.type||"string"!=typeof r.data._id)return c;if(r.data._id===n)return l;let a=r.data._id.split(".");return a.length>=2&&"drafts"===a[0]&&a.slice(1).join(".")===n||a.length>=3&&"versions"===a[0]&&a.slice(2).join(".")===n?l:p}),ep.versionOf.arity=1,ep.partOfRelease=N(e=>[e[0],{type:"This"}],(e,t,r)=>{if("string"!==t.type)return c;let n=t.data;if("object"!==r.type||"string"!=typeof r.data._id)return c;let a=r.data._id.split(".");return a.length>=3&&"versions"===a[0]&&a[1]===n?l:p}),ep.partOfRelease.arity=1;let eu={};async function ef(e,t){if("OpCall"===e.type&&"match"===e.op)return ey(e.left,e.right,t);if("FuncCall"===e.type&&"boost"===e.name){let r=await ef(e.args[0],t),n=await M(e.args[1],t);return"number"===n.type&&r>0?r+n.data:0}switch(e.type){case"Or":return await ef(e.left,t)+await ef(e.right,t);case"And":{let r=await ef(e.left,t),n=await ef(e.right,t);return 0===r||0===n?0:r+n}default:{let r=await M(e,t);return"boolean"===r.type&&!0===r.data?1:0}}}async function ey(e,t,r){return ed(await M(e,r),await M(t,r))}function ed(e,t){let r=S(e,e=>v(e)),n=S(t,e=>A(e)),a=(e,t)=>{if(!t.success||0===e.parts.length||0===t.parts.length)return 0;let r=0;for(let n of t.parts){let t=e.parts.reduce((e,t)=>e+(n.test(t)?1:0),0);r+=2.2*t/(t+1.2)}return r};return"then"in r||"then"in n?(async()=>a(await r,await n))():a(r,n)}function eh(e){let t=[],r=[];for(let n of e){let e="asc";"Desc"===n.type?(e="desc",n=n.base):"Asc"===n.type&&(n=n.base),t.push(n),r.push(e)}return{mappers:t,directions:r}}function em(e,t){return e.sort((e,r)=>{for(let n=0;n<t.length;n++){let a=function(e,t){let r=b(e),n=b(t),a=j[r]||100,s=j[n]||100;if(a!==s)return a-s;let i=O(e,t);return null===i&&(i=0),i}(e[n+2],r[n+2]);if("desc"===t[n]&&(a=-a),0!==a)return a}return e[1]-r[1]}),e.map(e=>e[0])}eu.query=P(()=>{throw Error("not implemented")}),eu.query.arity=1;let eb={};eb.order={executeSync({base:e,args:t},r){let{mappers:n,directions:a}=eh(t),s=[],i=0,o=a.length;for(let t of e.data){let e=r.createNested(m(t)),a=[t,i];for(let t=0;t<o;t++){let r=T(n[t],e);a.push(r.data)}s.push(a),i++}return h(em(s,a))},async executeAsync({base:e,args:t},r){let{mappers:n,directions:a}=eh(t),s=[],i=0,o=a.length;for await(let t of e){let e=r.createNested(t),a=[await t.get(),i];for(let t=0;t<o;t++){let r=await M(n[t],e);a.push(await r.get())}s.push(a),i++}return h(em(s,a))}},eb.order.arity=e=>e>=1,eb.score={async executeAsync({base:e,args:t},r){let n=[],a=[];for await(let s of e){if("object"!==s.type){n.push(await s.get());continue}let e=r.createNested(s),i="number"==typeof s.data._score?s.data._score:0;for(let r of t)i+=await ef(r,e);let o=Object.assign({},s.data,{_score:i});a.push(o)}return a.sort((e,t)=>t._score-e._score),m(a)},executeSync({base:e,args:t},r){let n=[];for(let a of e.data){if("object"!==b(a))continue;let e=r.createNested(m(a)),s="number"==typeof a._score?a._score:0;for(let r of t)s+=function e(t,r){if("OpCall"===t.type&&"match"===t.op)return function(e,t,r){let n=ed(T(e,r),T(t,r));if("number"==typeof n)return n;throw Error("Found synchronous value in match()")}(t.left,t.right,r);if("FuncCall"===t.type&&"boost"===t.name){let n=e(t.args[0],r),a=T(t.args[1],r);return"number"===a.type&&n>0?n+a.data:0}switch(t.type){case"Or":return e(t.left,r)+e(t.right,r);case"And":{let n=e(t.left,r),a=e(t.right,r);return 0===n||0===a?0:n+a}default:{let e=T(t,r);return"boolean"===e.type&&!0===e.data?1:0}}}(r,e);let i=Object.assign({},a,{_score:s});n.push(i)}return n.sort((e,t)=>t._score-e._score),h(n)}},eb.score.arity=e=>e>=1;let eg={global:ea,string:en,array:Z,pt:ec,delta:ee,diff:X,media:ei,sanity:ep,math:es,dateTime:z,releases:el,text:eu,geo:er,documents:et};class ew{_string;marks;index;customFunctions;parseOptions;allowBoost=!1;constructor(e,t,r,n){this._string=e,this.marks=t,this.customFunctions=r,this.index=0,this.parseOptions=n}hasMark(e=0){return this.index+e<this.marks.length}getMark(e=0){return this.marks[this.index+e]}shift(){this.index+=1}process(e){let t=this.marks[this.index];this.shift();let r=e[t.name];if(!r)throw Error(`Unknown handler: ${t.name}`);return r.call(e,this,t)}processString(){return this.shift(),this.processStringEnd()}processStringEnd(){let e=this.marks[this.index-1],t=this.marks[this.index];return this.shift(),this.string.slice(e.position,t.position)}slice(e){let t=this.marks[this.index].position;return this.string.slice(t,t+e)}get string(){return this._string}}let ex=/^([\t\n\v\f\r \u0085\u00A0]|(\/\/[^\n]*\n))+/,ek=/^\d+/,e_=/^[a-zA-Z_][a-zA-Z_0-9]*/;function eE(e,t,r){let n=t,a;switch(e[t]){case"+":{let r=eE(e,eO(e,t+1),10);if("error"===r.type)return r;a=[{name:"pos",position:n}].concat(r.marks),t=r.position;break}case"-":{let r=eE(e,eO(e,t+1),8);if("error"===r.type)return r;a=[{name:"neg",position:n}].concat(r.marks),t=r.position;break}case"(":{let r=ev(e,t);if("error"===r.type)return r;t=r.position,a=r.marks;break}case"!":{let r=eE(e,eO(e,t+1),10);if("error"===r.type)return r;a=[{name:"not",position:n}].concat(r.marks),t=r.position;break}case"{":{let r=ej(e,t);if("error"===r.type)return r;a=r.marks,t=r.position;break}case"[":if(a=[{name:"array",position:t}],t=eO(e,t+1),"]"!==e[t])for(;;){"..."===e.slice(t,t+3)&&(a.push({name:"array_splat",position:t}),t=eO(e,t+3));let r=eE(e,t,0);if("error"===r.type)return r;if(a=a.concat(r.marks),t=eO(e,t=r.position),","!==e[t]||(t=eO(e,t+1),"]"===e[t]))break}if("]"!==e[t])return{type:"error",message:'Expected "]" after array expression',position:t};t++,a.push({name:"array_end",position:t});break;case"'":case'"':{let r=function(e,t){let r=e[t],n=[{name:"str",position:t+=1}];e:for(;;t++){if(t>e.length)return{type:"error",message:"Unexpected end of query",position:t};switch(e[t]){case r:n.push({name:"str_end",position:t}),t++;break e;case"\\":n.push({name:"str_pause",position:t}),"u"===e[t+1]?"{"===e[t+2]?(n.push({name:"unicode_hex",position:t+3}),t=e.indexOf("}",t+3),n.push({name:"unicode_hex_end",position:t})):(n.push({name:"unicode_hex",position:t+2}),n.push({name:"unicode_hex_end",position:t+6}),t+=5):(n.push({name:"single_escape",position:t+1}),t+=1),n.push({name:"str_start",position:t+1})}}return{type:"success",marks:n,position:t}}(e,t);if("error"===r.type)return r;a=r.marks,t=r.position;break}case"^":for(t++,a=[];"."===e[t]&&"^"===e[t+1];)a.push({name:"dblparent",position:n}),t+=2;a.push({name:"parent",position:n});break;case"@":a=[{name:"this",position:n}],t++;break;case"*":a=[{name:"everything",position:n}],t++;break;case"$":{let r=eC(e,t+1,e_);r&&(t+=1+r,a=[{name:"param",position:n},{name:"ident",position:n+1},{name:"ident_end",position:t}]);break}default:{let r=eC(e,t,ek);if(r){let s="integer";if("."===e[t+=r]){let r=eC(e,t+1,ek);r&&(s="float",t+=1+r)}if("e"===e[t]||"E"===e[t]){s="sci",("+"===e[++t]||"-"===e[t])&&t++;let r=eC(e,t,ek);if(!r)return{type:"error",message:"Exponent must be a number",position:t};t+=r}a=[{name:s,position:n},{name:s+"_end",position:t}];break}let s=eC(e,t,e_);if(s)switch(e[t+=s]){case":":case"(":{let r=eS(e,n,t);if("error"===r.type)return r;a=r.marks,t=r.position;break}default:a=[{name:"this_attr",position:n},{name:"ident",position:n},{name:"ident_end",position:t}]}}}if(!a)return{type:"error",message:"Expected expression",position:t};let s=12,i;t:for(;;){let o=eO(e,t);if(o===e.length){t=o;break}if("success"===(i=eA(e,o)).type){for(a.unshift({name:"traverse",position:n});"success"===i.type;)a=a.concat(i.marks),i=eA(e,eO(e,t=i.position));a.push({name:"traversal_end",position:t});continue}switch(e[o]){case"=":switch(e[o+1]){case">":{if(r>1||s<=1)break t;let i=eE(e,eO(e,o+2),1);if("error"===i.type)return i;(a=a.concat(i.marks)).unshift({name:"pair",position:n}),t=i.position,s=1;break}case"=":{if(r>4||s<=4)break t;let i=eE(e,eO(e,o+2),5);if("error"===i.type)return i;a.unshift({name:"comp",position:n}),a.push({name:"op",position:o},{name:"op_end",position:o+2}),a=a.concat(i.marks),t=i.position,s=4;break}default:break t}break;case"+":{if(r>6||s<6)break t;let i=eE(e,eO(e,o+1),7);if("error"===i.type)return i;(a=a.concat(i.marks)).unshift({name:"add",position:n}),t=i.position,s=6;break}case"-":{if(r>6||s<6)break t;let i=eE(e,eO(e,o+1),7);if("error"===i.type)return i;(a=a.concat(i.marks)).unshift({name:"sub",position:n}),t=i.position,s=6;break}case"*":{if("*"===e[o+1]){if(r>8||s<=8)break t;let i=eE(e,eO(e,o+2),8);if("error"===i.type)return i;(a=a.concat(i.marks)).unshift({name:"pow",position:n}),t=i.position,s=8;break}if(r>7||s<7)break t;let i=eE(e,eO(e,o+1),8);if("error"===i.type)return i;(a=a.concat(i.marks)).unshift({name:"mul",position:n}),t=i.position,s=7;break}case"/":{if(r>7||s<7)break t;let i=eE(e,eO(e,o+1),8);if("error"===i.type)return i;(a=a.concat(i.marks)).unshift({name:"div",position:n}),t=i.position,s=7;break}case"%":{if(r>7||s<7)break t;let i=eE(e,eO(e,o+1),8);if("error"===i.type)return i;(a=a.concat(i.marks)).unshift({name:"mod",position:n}),t=i.position,s=7;break}case"<":case">":{if(r>4||s<=4)break t;let i=o+1;"="===e[i]&&i++;let c=eE(e,eO(e,i),5);if("error"===c.type)return c;a.unshift({name:"comp",position:n}),a.push({name:"op",position:o},{name:"op_end",position:i}),a=a.concat(c.marks),t=c.position,s=4;break}case"|":if("|"===e[o+1]){if(r>2||s<2)break t;let i=eE(e,eO(e,o+2),3);if("error"===i.type)return i;(a=a.concat(i.marks)).unshift({name:"or",position:n}),t=i.position,s=2}else{if(r>11||s<11)break t;let i=eO(e,o+1),c=eC(e,i,e_);if(!c)return{type:"error",message:"Expected identifier",position:i};if("("===e[t=i+c]||":"===e[t]){let r=eS(e,i,t);if("error"===r.type)return r;(a=a.concat(r.marks)).unshift({name:"pipecall",position:n}),t=r.position,s=11}}break;case"&":{if("&"!=e[o+1]||r>3||s<3)break t;let i=eE(e,eO(e,o+2),4);if("error"===i.type)return i;(a=a.concat(i.marks)).unshift({name:"and",position:n}),t=i.position,s=3;break}case"!":{if("="!==e[o+1]||r>4||s<=4)break t;let i=eE(e,eO(e,o+2),5);if("error"===i.type)return i;a.unshift({name:"comp",position:n}),a.push({name:"op",position:o},{name:"op_end",position:o+2}),a=a.concat(i.marks),t=i.position,s=4;break}case"d":if("desc"!==e.slice(o,o+4)||r>4||s<4)break t;a.unshift({name:"desc",position:n}),t=o+4,s=4;break;case"a":if("asc"!==e.slice(o,o+3)||r>4||s<4)break t;a.unshift({name:"asc",position:n}),t=o+3,s=4;break;default:switch(e$(e,o,e_)){case"in":{if(r>4||s<=4)break t;t=eO(e,o+2);let i=!1;"("===e[t]&&(i=!0,t=eO(e,t+1));let c=t,l=eE(e,t,5);if("error"===l.type)return l;if(t=eO(e,l.position),"."===e[t]&&"."===e[t+1]){let r="inc_range";"."===e[t+2]?(r="exc_range",t=eO(e,t+3)):t=eO(e,t+2);let s=eE(e,t,5);if("error"===s.type)return s;a.unshift({name:"in_range",position:n}),a=a.concat({name:r,position:c},l.marks,s.marks),t=s.position}else a.unshift({name:"comp",position:n}),a.push({name:"op",position:o},{name:"op_end",position:o+2}),a=a.concat(l.marks);if(i){if(t=eO(e,t),")"!==e[t])return{type:"error",message:'Expected ")" in group',position:t};t++}s=4;break}case"match":{if(r>4||s<=4)break t;let i=eE(e,eO(e,o+5),5);if("error"===i.type)return i;a.unshift({name:"comp",position:n}),a.push({name:"op",position:o},{name:"op_end",position:o+5}),a=a.concat(i.marks),t=i.position,s=4;break}default:break t}}}return{type:"success",marks:a,position:t,failPosition:i?.type==="error"&&i.position}}function ev(e,t){let r=t,n,a=eE(e,eO(e,t+1),0);if("error"===a.type)return a;switch(t=eO(e,a.position),e[t]){case",":for(n=[{name:"tuple",position:r}].concat(a.marks),t=eO(e,t+1);;){if("error"===(a=eE(e,t,0)).type)return a;if(n.push(...a.marks),t=eO(e,a.position),","!==e[t])break;t=eO(e,t+1)}if(")"!==e[t])return{type:"error",message:'Expected ")" after tuple expression',position:t};t++,n.push({name:"tuple_end",position:t});break;case")":t++,n=[{name:"group",position:r}].concat(a.marks);break;default:return{type:"error",message:`Unexpected character "${e[t]}"`,position:t}}return{type:"success",marks:n,position:t}}function eA(e,t){let r=t;switch(e[t]){case".":{if(t=eO(e,t+1),"("===e[t])return ev(e,t);let n=t,a=eC(e,t,e_);return a?{type:"success",marks:[{name:"attr_access",position:r},{name:"ident",position:n},{name:"ident_end",position:t+=a}],position:t}:{type:"error",message:'Expected identifier after "."',position:t}}case"-":if(">"!==e[t+1])return{type:"error",message:'Expected ">" in reference',position:t};let n=[{name:"deref",position:r}],a=eO(e,t+=2),s=eC(e,a,e_);return s&&(t=a+s,n.push({name:"deref_attr",position:a},{name:"ident",position:a},{name:"ident_end",position:t})),{type:"success",marks:n,position:t};case"[":{if(t=eO(e,t+1),"]"===e[t])return{type:"success",marks:[{name:"array_postfix",position:r}],position:t+1};let n=t,a=eE(e,t,0);if("error"===a.type)return a;if(t=eO(e,a.position),"."===e[t]&&"."===e[t+1]){let s="inc_range";"."===e[t+2]?(s="exc_range",t+=3):t+=2,t=eO(e,t);let i=eE(e,t,0);return"error"===i.type?i:(t=eO(e,i.position),"]"!==e[t]?{type:"error",message:'Expected "]" after array expression',position:t}:{type:"success",marks:[{name:"slice",position:r},{name:s,position:n}].concat(a.marks,i.marks),position:t+1})}return"]"!==e[t]?{type:"error",message:'Expected "]" after array expression',position:t}:{type:"success",marks:[{name:"square_bracket",position:r}].concat(a.marks),position:t+1}}case"|":if(t=eO(e,t+1),"{"===e[t]){let n=ej(e,t);return"error"===n.type||n.marks.unshift({name:"projection",position:r}),n}break;case"{":{let n=ej(e,t);return"error"===n.type||n.marks.unshift({name:"projection",position:r}),n}}return{type:"error",message:"Unexpected character in traversal",position:t}}function eS(e,t,r){let n=[];if(n.push({name:"func_call",position:t}),":"===e[r]&&":"===e[r+1]){n.push({name:"namespace",position:t}),n.push({name:"ident",position:t},{name:"ident_end",position:r}),r=eO(e,r+2);let a=eC(e,r,e_);if(!a)return{type:"error",message:"Expected function name",position:r};if(n.push({name:"ident",position:r},{name:"ident_end",position:r+a}),r=eO(e,r+a),"("!==e[r])return{type:"error",message:'Expected "(" after function name',position:r};r=eO(e,++r)}else n.push({name:"ident",position:t},{name:"ident_end",position:r}),r=eO(e,r+1);let a=r;if(")"!==e[r])for(;;){let t=eE(e,r,0);if("error"===t.type)return t;if(n=n.concat(t.marks),a=t.position,r=eO(e,t.position),","!==e[r]||(r=eO(e,r+1),")"===e[r]))break}return")"!==e[r]?{type:"error",message:'Expected ")" after function arguments',position:r}:(n.push({name:"func_args_end",position:a}),{type:"success",marks:n,position:r+1})}function ej(e,t){let r=[{name:"object",position:t}];for(t=eO(e,t+1);"}"!==e[t];){let n=t;if("..."===e.slice(t,t+3)){if(t=eO(e,t+3),"}"!==e[t]&&","!==e[t]){let a=eE(e,t,0);if("error"===a.type)return a;r.push({name:"object_splat",position:n}),r=r.concat(a.marks),t=a.position}else r.push({name:"object_splat_this",position:n})}else{let a=eE(e,t,0);if("error"===a.type)return a;let s=eO(e,a.position);if("str"===a.marks[0].name&&":"===e[s]){let i=eE(e,eO(e,s+1),0);if("error"===i.type)return i;r.push({name:"object_pair",position:n}),r=r.concat(a.marks,i.marks),t=i.position}else r=r.concat({name:"object_expr",position:t},a.marks),t=a.position}if(t=eO(e,t),","!==e[t])break;t=eO(e,t+1)}return"}"!==e[t]?{type:"error",message:'Expected "}" after object',position:t}:(t++,r.push({name:"object_end",position:t}),{type:"success",marks:r,position:t})}function eO(e,t){return t+eC(e,t,ex)}function eC(e,t,r){let n=r.exec(e.slice(t));return n?n[0].length:0}function e$(e,t,r){let n=r.exec(e.slice(t));return n?n[0]:null}function eI(e,t){return r=>t(e(r))}function eT(e){return t=>({type:"Map",base:t,expr:e({type:"This"})})}function eM(e,t){if(!t)return{type:"a-a",build:e};switch(t.type){case"a-a":return{type:"a-a",build:eI(e,t.build)};case"a-b":return{type:"a-b",build:eI(e,t.build)};case"b-b":return{type:"a-a",build:eI(e,eT(t.build))};case"b-a":var r;return{type:"a-a",build:eI(e,(r=t.build,e=>({type:"FlatMap",base:e,expr:r({type:"This"})})))};default:throw Error(`unknown type: ${t.type}`)}}function eF(e,t){if(!t)return{type:"b-b",build:e};switch(t.type){case"a-a":case"b-a":return{type:"b-a",build:eI(e,t.build)};case"a-b":case"b-b":return{type:"b-b",build:eI(e,t.build)};default:throw Error(`unknown type: ${t.type}`)}}function eP(e,t=0){switch(e.type){case"Projection":case"Filter":return{...e,base:eP(e.base,t),expr:eP(e.expr,t+1)};case"Parent":if(t-e.n<0)throw Error(`Invalid use of parent operator (^). No parent n ${e.n} at level ${t}.`);return e;case"Parameter":throw Error(`Function parameters are not allowed outside function declarations: ${e.name}`);case"Array":return{...e,elements:e.elements.map(e=>({...e,value:eP(e.value,t)}))};case"PipeFuncCall":return{...e,base:eP(e.base,t),args:e.args.map(e=>eP(e,t))};case"Object":return{...e,attributes:e.attributes.map(e=>{switch(e.type){case"ObjectAttributeValue":case"ObjectSplat":return{...e,value:eP(e.value,t)};case"ObjectConditionalSplat":return{...e,condition:eP(e.condition,t),value:eP(e.value,t)};default:return e}})};case"FlatMap":case"Map":return{...e,expr:eP(e.expr,t),base:eP(e.base,t)};case"FuncCall":return{...e,args:e.args.map(e=>eP(e,t))};case"Tuple":return{...e,members:e.members.map(e=>eP(e,t))};case"Select":{let r=e.alternatives.map(e=>({...e,condition:eP(e.condition,t),value:eP(e.value,t)}));return e.fallback?{...e,alternatives:r,fallback:eP(e.fallback,t)}:{...e,alternatives:r}}case"SelectorNested":return{...e,base:eP(e.base,t),nested:eP(e.nested,t)};case"SelectorFuncCall":return{...e,arg:eP(e.arg,t)};case"AccessAttribute":case"AccessElement":case"ArrayCoerce":case"Asc":case"Desc":case"Deref":case"Group":case"Neg":case"Not":case"Slice":case"Pos":return e.base?{...e,base:eP(e.base,t)}:e;case"InRange":return{...e,base:eP(e.base,t),left:eP(e.left,t),right:eP(e.right,t)};case"OpCall":case"And":case"Or":return{...e,left:eP(e.left,t),right:eP(e.right,t)};case"Everything":case"This":case"Value":case"Context":return e;default:throw Error(`Handle all cases: ${e.type}`)}}let eN={"'":"'",'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:`
`,r:"\r",t:"	"};class eU extends Error{name="GroqQueryError"}function eD(e=new Set){let t={group:e=>({type:"Group",base:e.process(t)}),everything:()=>({type:"Everything"}),this:()=>({type:"This"}),parent:()=>({type:"Parent",n:1}),dblparent:e=>({type:"Parent",n:e.process(t).n+1}),traverse(e){let r=e.process(t),a=[];for(;"traversal_end"!==e.getMark().name;)a.push(e.process(n));e.shift();let s=null;for(let e=a.length-1;e>=0;e--)s=a[e](s);if(("Everything"===r.type||"Array"===r.type||"PipeFuncCall"===r.type)&&(s=eM(e=>e,s)),null===s)throw Error("BUG: unexpected empty traversal");return s.build(r)},this_attr(e){let t=e.processString();return"null"===t?{type:"Value",value:null}:"true"===t?{type:"Value",value:!0}:"false"===t?{type:"Value",value:!1}:{type:"AccessAttribute",name:t}},neg:e=>({type:"Neg",base:e.process(t)}),pos:e=>({type:"Pos",base:e.process(t)}),add:e=>({type:"OpCall",op:"+",left:e.process(t),right:e.process(t)}),sub:e=>({type:"OpCall",op:"-",left:e.process(t),right:e.process(t)}),mul:e=>({type:"OpCall",op:"*",left:e.process(t),right:e.process(t)}),div:e=>({type:"OpCall",op:"/",left:e.process(t),right:e.process(t)}),mod:e=>({type:"OpCall",op:"%",left:e.process(t),right:e.process(t)}),pow:e=>({type:"OpCall",op:"**",left:e.process(t),right:e.process(t)}),comp(e){let r=e.process(t);return{type:"OpCall",op:e.processString(),left:r,right:e.process(t)}},in_range(e){let r=e.process(t),n="inc_range"===e.getMark().name;return e.shift(),{type:"InRange",base:r,left:e.process(t),right:e.process(t),isInclusive:n}},str(e){let t="";t:for(;e.hasMark();){let r=e.getMark();switch(r.name){case"str_end":t+=e.processStringEnd();break t;case"str_pause":t+=e.processStringEnd();break;case"str_start":e.shift();break;case"single_escape":{let r=e.slice(1);e.shift(),t+=eN[r];break}case"unicode_hex":e.shift(),t+=String.fromCharCode(parseInt(e.processStringEnd(),16));break;default:throw Error(`unexpected mark: ${r.name}`)}}return{type:"Value",value:t}},integer:e=>({type:"Value",value:Number(e.processStringEnd())}),float:e=>({type:"Value",value:Number(e.processStringEnd())}),sci:e=>({type:"Value",value:Number(e.processStringEnd())}),object(e){let t=[];for(;"object_end"!==e.getMark().name;)t.push(e.process(r));return e.shift(),{type:"Object",attributes:t}},array(e){let r=[];for(;"array_end"!==e.getMark().name;){let n=!1;"array_splat"===e.getMark().name&&(n=!0,e.shift());let a=e.process(t);r.push({type:"ArrayElement",value:a,isSplat:n})}return e.shift(),{type:"Array",elements:r}},tuple(e){let r=[];for(;"tuple_end"!==e.getMark().name;)r.push(e.process(t));return e.shift(),{type:"Tuple",members:r}},func_call(r){let n="global";"namespace"===r.getMark().name&&(r.shift(),n=r.processString());let s=r.processString();if("global"===n&&"select"===s){let e={type:"Select",alternatives:[]};for(;"func_args_end"!==r.getMark().name;)if("pair"===r.getMark().name){if(e.fallback)throw new eU("unexpected argument to select()");r.shift();let n=r.process(t),a=r.process(t);e.alternatives.push({type:"SelectAlternative",condition:n,value:a})}else{if(e.fallback)throw new eU("unexpected argument to select()");let n=r.process(t);e.fallback=n}return r.shift(),e}let i=[];for(;"func_args_end"!==r.getMark().name;){var o,c;(o=n,c=i.length,"diff"==o&&2==c&&["changedAny","changedOnly"].includes(s))?i.push(r.process(a)):i.push(r.process(t))}if(r.shift(),"global"===n&&("before"===s||"after"===s)&&"delta"===r.parseOptions.mode)return{type:"Context",key:s};if("global"===n&&"boost"===s&&!r.allowBoost)throw new eU("unexpected boost");let l=r.customFunctions[`${n}::${s}`];if(void 0!==l){let t=eR(e),n=new ew(r.string,l.marks,r.customFunctions,{}).process(t);return eV(s,n.params.length,i.length),eq(n.body,e=>eP(e),e=>(function(e,t,r){if("Parameter"!==e.type)throw new eU(`Expected parameter node, got ${e.type}`);let n=t.findIndex(t=>t.name===e.name);if(-1===n)throw new eU(`Missing argument for parameter ${e.name} in function call`);return r[n]})(e,n.params,i))}let p=eg[n];if(!p)throw new eU(`Undefined namespace: ${n}`);let u=p[s];if(!u||(void 0!==u.arity&&eV(s,u.arity,i.length),void 0!==u.mode&&u.mode!==r.parseOptions.mode))throw new eU(`Undefined function: ${s}`);return{type:"FuncCall",namespace:n,name:s,args:i,func:u}},pipecall(e){let r=e.process(t);e.shift();let n="global";if("namespace"===e.getMark().name&&(e.shift(),n=e.processString()),"global"!==n)throw new eU(`Undefined namespace: ${n}`);let a=e.processString(),s=[],i=e.allowBoost;for("score"===a&&(e.allowBoost=!0);;){let r=e.getMark().name;if("func_args_end"===r)break;if("order"===a){if("asc"===r){e.shift(),s.push({type:"Asc",base:e.process(t)});continue}if("desc"===r){e.shift(),s.push({type:"Desc",base:e.process(t)});continue}}s.push(e.process(t))}e.shift(),e.allowBoost=i;let o=eb[a];if(!o)throw new eU(`Undefined pipe function: ${a}`);return o.arity&&eV(a,o.arity,s.length),{type:"PipeFuncCall",func:o,base:r,name:a,args:s}},pair(){throw new eU("unexpected =>")},and:e=>({type:"And",left:e.process(t),right:e.process(t)}),or:e=>({type:"Or",left:e.process(t),right:e.process(t)}),not:e=>({type:"Not",base:e.process(t)}),asc(){throw new eU("unexpected asc")},desc(){throw new eU("unexpected desc")},param(e){let t=e.processString();return e.parseOptions.params&&e.parseOptions.params.hasOwnProperty(t)?{type:"Value",value:e.parseOptions.params[t]}:{type:"Parameter",name:t}}},r={object_expr(e){if("pair"===e.getMark().name)return e.shift(),{type:"ObjectConditionalSplat",condition:e.process(t),value:e.process(t)};let r=e.process(t);return{type:"ObjectAttributeValue",name:function e(t){if("AccessAttribute"===t.type&&!t.base)return t.name;if("PipeFuncCall"===t.type||"Deref"===t.type||"Map"===t.type||"Projection"===t.type||"Slice"===t.type||"Filter"===t.type||"AccessElement"===t.type||"ArrayCoerce"===t.type||"Group"===t.type)return e(t.base);throw new eU(`Cannot determine property key for type: ${t.type}`)}(r),value:r}},object_pair(e){let r=e.process(t);if("Value"!==r.type)throw Error("name must be string");let n=e.process(t);return{type:"ObjectAttributeValue",name:r.value,value:n}},object_splat:e=>({type:"ObjectSplat",value:e.process(t)}),object_splat_this:()=>({type:"ObjectSplat",value:{type:"This"}})},n={square_bracket(e){let r=e.process(t),n=R(r);return n&&"number"===n.type?e=>(function(e,t){if(!t)return{type:"a-b",build:e};switch(t.type){case"a-a":case"b-a":return{type:"a-a",build:eI(e,t.build)};case"a-b":case"b-b":return{type:"a-b",build:eI(e,t.build)};default:throw Error(`unknown type: ${t.type}`)}})(e=>({type:"AccessElement",base:e,index:n.data}),e):n&&"string"===n.type?e=>eF(e=>({type:"AccessAttribute",base:e,name:n.data}),e):e=>eM(e=>({type:"Filter",base:e,expr:r}),e)},slice(e){let r="inc_range"===e.getMark().name;e.shift();let n=e.process(t),a=e.process(t),s=R(n),i=R(a);if(!s||!i||"number"!==s.type||"number"!==i.type)throw new eU("slicing must use constant numbers");return e=>eM(e=>({type:"Slice",base:e,left:s.data,right:i.data,isInclusive:r}),e)},projection(e){let r=e.process(t);return e=>(function(e,t){if(!t)return{type:"b-b",build:e};switch(t.type){case"a-a":return{type:"a-a",build:eI(eT(e),t.build)};case"a-b":return{type:"a-b",build:eI(eT(e),t.build)};case"b-a":return{type:"b-a",build:eI(e,t.build)};case"b-b":return{type:"b-b",build:eI(e,t.build)};default:throw Error(`unknown type: ${t.type}`)}})(e=>({type:"Projection",base:e,expr:r}),e)},attr_access(e){let t=e.processString();return e=>eF(e=>({type:"AccessAttribute",base:e,name:t}),e)},deref(e){let t=null;"deref_attr"===e.getMark().name&&(e.shift(),t=e.processString());let r=e=>t?{type:"AccessAttribute",base:e,name:t}:e;return e=>eF(e=>r({type:"Deref",base:e}),e)},array_postfix:()=>e=>eM(e=>({type:"ArrayCoerce",base:e}),e)},a={group:e=>e.process(a),everything(){throw Error("Invalid selector syntax")},this(){throw Error("Invalid selector syntax")},parent(){throw Error("Invalid selector syntax")},dblparent(){throw Error("Invalid selector syntax")},traverse(e){let r=e.process(a);for(;"traversal_end"!==e.getMark().name;)if("array_postfix"===e.getMark().name)e.shift(),r={type:"ArrayCoerce",base:r};else if("square_bracket"===e.getMark().name){e.shift();let n=e.process(t),a=R(n);if(a&&"number"===a.type)throw Error("Invalid array access expression");r=a&&"string"===a.type?{type:"AccessAttribute",base:r,name:a.data}:{type:"Filter",base:r,expr:n}}else if("attr_access"===e.getMark().name)e.shift(),r={type:"AccessAttribute",base:r,name:e.processString()};else if("tuple"===e.getMark().name||"group"===e.getMark().name){let t=e.process(a);if(!["AccessAttribute","ArrayCoerce","Filter","Group","Tuple","SelectorNested"].includes(t.type))throw Error(`Unexpected result parsing nested selector: ${t.type}`);r={type:"SelectorNested",base:r,nested:t}}else throw Error("Invalid selector syntax");return e.shift(),r},this_attr:e=>({type:"AccessAttribute",name:e.processString()}),attr_access(){throw Error("Invalid selector syntax")},neg(){throw Error("Invalid selector syntax")},pos(){throw Error("Invalid selector syntax")},add(){throw Error("Invalid selector syntax")},sub(){throw Error("Invalid selector syntax")},mul(){throw Error("Invalid selector syntax")},div(){throw Error("Invalid selector syntax")},mod(){throw Error("Invalid selector syntax")},pow(){throw Error("Invalid selector syntax")},comp(){throw Error("Invalid selector syntax")},in_range(){throw Error("Invalid selector syntax")},str(){throw Error("Invalid selector syntax")},integer(){throw Error("Invalid selector syntax")},float(){throw Error("Invalid selector syntax")},sci(){throw Error("Invalid selector syntax")},object(){throw Error("Invalid selector syntax")},array(){throw Error("Invalid selector syntax")},tuple(e){let t=[];for(;"tuple_end"!==e.getMark().name;)t.push(e.process(a));return e.shift(),{type:"Tuple",members:t}},func_call(e,r){let n=t.func_call(e,r);if("anywhere"===n.name&&1===n.args.length)return{type:"SelectorFuncCall",name:"anywhere",arg:n.args[0]};throw Error("Invalid selector syntax")},pipecall(){throw Error("Invalid selector syntax")},pair(){throw Error("Invalid selector syntax")},and(){throw Error("Invalid selector syntax")},or(){throw Error("Invalid selector syntax")},not(){throw Error("Invalid selector syntax")},asc(){throw Error("Invalid selector syntax")},desc(){throw Error("Invalid selector syntax")},param(){throw Error("Invalid selector syntax")}};return t}function eV(e,t,r){if("number"==typeof t){if(r!==t)throw new eU(`Incorrect number of arguments to function ${e}(). Expected ${t}, got ${r}.`)}else if(t&&!t(r))throw new eU(`Incorrect number of arguments to function ${e}().`)}function eq(e,t,r=e=>e){if("Projection"===e.type){if("Parameter"===e.base.type)return{type:"Projection",base:r(e.base),expr:t(e.expr)};if("Deref"===e.base.type&&"Parameter"===e.base.base.type)return{type:"Projection",base:{type:"Deref",base:r(e.base.base)},expr:t(e.expr)}}if("Map"===e.type&&"ArrayCoerce"===e.base.type&&"Parameter"===e.base.base.type)return{type:"Map",base:{type:"ArrayCoerce",base:r(e.base.base)},expr:t(e.expr)};throw new eU(`Unexpected function body, must be a projection. Got "${e.type}"`)}class eG extends Error{position;name="GroqSyntaxError";constructor(e,t){super(`Syntax error in GROQ query at position ${e}${t?`: ${t}`:""}`),this.position=e}}function eH(e,t={}){let r=function(e){let t=0;t=eO(e,0);let r={};for(;t<e.length&&"fn"===e.substring(t,t+2);){let n=function(e,t){let r=t,n=[],a="",s="";if("fn"!==e.substring(r,r+2))return{type:"success",position:r,marks:n};n.push({name:"func_decl",position:t});let i=r=eO(e,r+2);if(!(a=e$(e,r,e_)))return{type:"error",message:"Expected function name",position:r};if(n.push({name:"ident",position:i},{name:"ident_end",position:r+a.length}),r=eO(e,r+a.length),"::"!==e.substring(r,r+2))return{type:"error",message:'Expected "::" after namespace',position:r};if(r=eO(e,r+2),!(s=e$(e,r,e_)))return{type:"error",message:"Expected function name",position:r};if(n.push({name:"ident",position:r},{name:"ident_end",position:r+s.length}),r=eO(e,r+s.length),"("!==e[r])return{type:"error",message:'Expected "("',position:r};for(r=eO(e,r+1);r<e.length&&")"!==e[r];){if("$"!==e[r])return{type:"error",message:'Parameter should start with "$"',position:r};let t=r,a=e$(e,++r,e_);if(!a)return{type:"error",message:"Expected function name",position:r};if(r+=a.length,n.push({name:"param",position:t},{name:"ident",position:t+1},{name:"ident_end",position:r}),r=eO(e,r),","===e[r])r=eO(e,r+1);else if(")"!==e[r])return{type:"error",message:'Expected "," or ")"',position:r}}if(")"!==e[r])return{type:"error",message:'Expected ")"',position:r};if(n.push({name:"func_params_end",position:r}),r=eO(e,r+1),"="!==e[r])return{type:"error",message:'Expected "="',position:r};r=eO(e,r+1);let o=eE(e,r,0);return"error"===o.type?o:(n=n.concat(o.marks),r=eO(e,o.position),";"!==e[r]?{type:"error",message:'Expected ";" after function declaration',position:r}:{type:"success",position:++r,marks:n,namespace:a,name:s})}(e,t);if("error"===n.type)return n;r[`${n.namespace}::${n.name}`]=n,t=eO(e,n.position)}let n=eE(e,t,0);return"error"===n.type?n:(t=eO(e,n.position))!==e.length?(n.failPosition&&(t=n.failPosition-1),{type:"error",message:"Unexpected end of query",position:t}):(delete n.position,delete n.failPosition,n.customFunctions=r,n)}(e);if("error"===r.type)throw new eG(r.position,r.message);!function(e,t){for(let r in t){if(!t.hasOwnProperty(r))continue;let n=new ew(e,t[r].marks,t,{}),a=eR();eq(n.process(a).body,e=>eP(e))}}(e,r.customFunctions);let n=new ew(e,r.marks,r.customFunctions,t),a=eD();return n.process(a)}function eR(e=new Set){return{func_decl(t){let r=t.processString(),n=t.processString(),a=`${r}::${n}`;if(e.has(a))throw new eU(`Recursive function definition detected for ${a}`);let s=eD(new Set([...e,a])),i=[];for(;"func_params_end"!==t.getMark().name;){let e=t.process(s);if("Parameter"!==e.type)throw Error("expected parameter");i.push(e)}if(1!==i.length)throw new eU("Custom functions can only have one parameter");return t.shift(),{type:"FuncDeclaration",namespace:r,name:n,params:i,body:t.process(s)}}}}let{compare:eB}=new Intl.Collator("en");Symbol("groq-js.type.string_datetime"),n("typeEvaluator:scope:trace").log=console.log.bind(console),n("typeEvaluator:evaluate:trace").log=console.log.bind(console),n("typeEvaluator:evaluate:debug").log=console.log.bind(console),n("typeEvaluator:evaluate:warn"),Symbol("groq-js.type")}}]);